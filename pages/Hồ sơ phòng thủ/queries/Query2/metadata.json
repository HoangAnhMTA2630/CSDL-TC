{
  "gitSyncId": "682d4d2a92cca105dbc17693_da809086-73ea-4b60-b144-7c4b6935f48c",
  "id": "Hồ sơ phòng thủ_Query2",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH RECURSIVE DonViDuocChon AS (\n  SELECT id, ten_don_vi\n  FROM don_vi_phong_thu\n  WHERE {{ TreeSelect.selectedOptionValue ? (\"id = \" + TreeSelect.selectedOptionValue) : \"don_vi_cha_id IS NULL\" }}\n),\nDonViConTrucTiep AS (\n  SELECT id, ten_don_vi\n  FROM don_vi_phong_thu\n  WHERE don_vi_cha_id = {{ TreeSelect.selectedOptionValue || 'NULL' }}\n),\nDonViConDeQuy AS (\n  SELECT id, ten_don_vi, id AS goc_id\n  FROM DonViConTrucTiep\n  UNION ALL\n  SELECT dv.id, dv.ten_don_vi, dvc.goc_id\n  FROM don_vi_phong_thu dv\n  JOIN DonViConDeQuy dvc ON dv.don_vi_cha_id = dvc.id\n)\n\n-- Đơn vị được chọn: priority = 0\nSELECT \n  dvc.ten_don_vi AS x,\n  COUNT(etb.id) AS y,\n  0 AS priority\nFROM DonViDuocChon dvc\nLEFT JOIN ho_so_phong_thu hspt ON hspt.don_vi_id = dvc.id\nLEFT JOIN e_thiet_bi_mang etb ON etb.ho_so_phong_thu_id = hspt.id\nGROUP BY dvc.ten_don_vi\n\nUNION ALL\n\n-- Các đơn vị con: priority = 1\nSELECT \n  dv_goc.ten_don_vi AS x,\n  COUNT(etb.id) AS y,\n  1 AS priority\nFROM DonViConDeQuy dvc\nJOIN don_vi_phong_thu dv_goc ON dv_goc.id = dvc.goc_id\nLEFT JOIN ho_so_phong_thu hspt ON hspt.don_vi_id = dvc.id\nLEFT JOIN e_thiet_bi_mang etb ON etb.ho_so_phong_thu_id = hspt.id\nGROUP BY dv_goc.ten_don_vi\n\n-- Sắp xếp A trước, rồi đến B, C...\nORDER BY priority, x;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": false
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "csdltc",
      "isAutoGenerated": false,
      "name": "csdltc",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "executeOnLoad": false,
    "name": "Query2",
    "pageId": "Hồ sơ phòng thủ",
    "userSetOnLoad": true
  }
}