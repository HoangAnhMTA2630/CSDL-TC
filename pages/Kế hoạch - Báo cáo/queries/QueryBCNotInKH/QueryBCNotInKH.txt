SELECT 
  bc.*,
  cbc.ten_cap,
  lbc.ten_loai_bao_cao
FROM bao_cao bc
LEFT JOIN cap cbc ON bc.cap_bao_cao_id = cbc.id
LEFT JOIN loai_bao_cao lbc ON bc.loai_bao_cao_id = lbc.id
WHERE (
    {{ data_tableBCNotInKH.searchText ? 
      `bc.so_bao_cao ILIKE '%${data_tableBCNotInKH.searchText}%'` 
      : 'TRUE' }}
  ) AND
  bc.id NOT IN (
    SELECT DISTINCT bao_cao_id FROM ke_hoach_bao_cao
  )

  -- Tìm kiếm theo số báo cáo (cho phép NULL)
   

  -- Lọc theo năm nếu có chọn
  AND (
    {{ SelectNamBCNotInKH.selectedOptionValue 
        ? `EXTRACT(YEAR FROM bc.ngay_ban_hanh) = ${SelectNamBCNotInKH.selectedOptionValue}` 
        : 'TRUE' }}
  )

  -- Lọc theo quý nếu có chọn
  AND (
    {{ SelectQuyBCNotInKH.selectedOptionValue 
        ? `CEIL(EXTRACT(MONTH FROM bc.ngay_ban_hanh)::numeric / 3) = ${SelectQuyBCNotInKH.selectedOptionValue}` 
        : 'TRUE' }}
  )

  -- Lọc theo tháng nếu có chọn
  AND (
    {{ SelectThangBCNotInKH.selectedOptionValue 
        ? `EXTRACT(MONTH FROM bc.ngay_ban_hanh) = ${SelectThangBCNotInKH.selectedOptionValue}` 
        : 'TRUE' }}
  )

ORDER BY bc.ngay_ban_hanh DESC;
